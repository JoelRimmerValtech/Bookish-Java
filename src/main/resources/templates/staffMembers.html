<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{master.html}">

<!--@thymesVar id="members" type="org.softwire.training.bookish.models.page.StaffPageMemberModel"-->

<head>
    <title>Manage Members</title>
    <link rel="stylesheet" href="/styles/staffMembers.css"/>
</head>

<body>

<div layout:fragment="main">

    <h1 class="membersheading">Members List</h1>

    <table>
        <thead>
        <tr>
            <th>ID</th>
            <th>Forename</th>
            <th>Surname</th>
            <th>Librarian?</th>
            <th>Modify</th>
            <th>Delete</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="member : ${members.memberList}">
            <td class="id" th:text="${member.memberId}"></td>
            <td class="sname" th:text="${member.surname}"></td>
            <td class="fname" th:text="${member.forename}"></td>
            <td class="librarian" th:text="${member.librarian}"></td>
            <td class="edit">Edit</td>
            <td class="trash">Delete</td>
        </tr>
        <tr>
            <td class="new-row" colspan="4">Add New Member</td>
        </tr>
        </tbody>
    </table>

    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 text-center addmembers">
            <h2>Add Member</h2>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 col-xs-offset-3">
            <form id="contact-form" class="form" action="/staff/members/add" method="POST" role="form">
                <div class="form-group">
                    <label class="form-label" for="forename">Forename</label>
                    <input type="text" class="form-control" id="forename" name="forename" placeholder="Your first name"
                           tabindex="1" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="surname">Surname</label>
                    <input type="text" class="form-control" id="surname" name="surname" placeholder="Your Surname"
                           tabindex="2" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="librarian">Librarian Staff?</label>
                    <input type="checkbox" class="form-control" id="librarian" name="librarian" placeholder="Subject"
                           tabindex="3">
                </div>
                <div class="text-center">
                    <button type="submit" class="btn btn-start-order">Add Member</button>
                </div>
            </form>
        </div>
    </div>


    <script src="jquery-3.3.1.min.js"></script>

    <script>
        var isEditing = false,
            tempIdValue = 0,
            tempFnameValue = "",
            tempSnameValue = "",
            tempLibrarianValue = "",

            // Handles live/dynamic element events, i.e. for newly created edit buttons
            $;(document).on('click', '.edit', function () {
            var parentRow = $(this).closest('tr'),
                tableBody = parentRow.closest('tbody'),
                tdId = parentRow.children('td.id'),
                tdFname = parentRow.children('td.fname'),
                tdSname = parentRow.children('td.sname'),
                tdLibr = parentRow.children('td.librarian');

            if (isEditing) {
                var fnameInput = tableBody.find('input[name="fname"]'),
                    snameInput = tableBody.find('input[name="sname"]'),
                    librInput = tableBody.find('input[name="librarian"]'),
                    tdId = tableBody.find('input[name="id"]').closest('td'),
                    tdFname = fnameInput.closest('td'),
                    tdSname = snameInput.closest('td'),
                    tdLibr = librInput.closest('td'),
                    currentEdit = tdLibr.parent().find('td.edit');

                if ($(this).is(currentEdit)) {
                    // Save new values as static html
                    var tdIdValue = tdId.prop('value');
                        tdFnameValue = fnameInput.prop('value');
                    fnameInput.empty();
                    var Http = new XMLHttpRequest();
                    var url = location.href + '/edit';
                    Http.open('POST', url);
                    Http.send(`id=${tdIdValue}&forename=${tdFnameValue}`);

                } else {
                    // Restore previous html values
                    tdNameInput.empty();
                    tdDataInput.empty();

                    tdNameInput.html(tempNameValue);
                    tdDataInput.html(tempDataValue);
                }
                // Display static row
                currentEdit.html('Edit');
                isEditing = false;
            } else {
                // Display editable input row
                isEditing = true;
                $(this).html('Save');

                var tdNameValue = tdName.html(),
                    tdDataValue = tdData.html();

                // Save current html values for canceling an edit
                tempNameValue = tdNameValue;
                tempDataValue = tdDataValue;

                // Remove existing html values
                tdName.empty();
                tdData.empty();

                // Create input forms
                tdName.html('<input type="text" name="name" value="' + tdNameValue + '">');
                tdData.html('<input type="text" name="data" value="' + tdDataValue + '">');
            }
        });

        // Handles live/dynamic element events, i.e. for newly created trash buttons
        $(document).on('click', '.trash', function () {
            // Turn off editing if row is current input
            if (isEditing) {
                var parentRow = $(this).closest('tr'),
                    tableBody = parentRow.closest('tbody'),
                    tdInput = tableBody.find('input').closest('td'),
                    currentEdit = tdInput.parent().find('td.edit'),
                    thisEdit = parentRow.find('td.edit');

                if (thisEdit.is(thisEdit)) {
                    isEditing = false;
                }
            }

            // Remove selected row from table
            // var Http = new XMLHttpRequest();
            // var url = location.href + '/edit';
            // Http.open('POST', url);
            // Http.send(`id=${tdIdValue}&forename=${tdFnameValue}`);

            $(this).closest('tr').remove();
        });

        $('.new-row').on('click', function () {
            var tableBody = $(this).closest('tbody'),
                trNew = '<tr><td class="name"><input type="text" name="name" value=""></td><td class="data"><input type="text" name="data" value=""></td><td class="edit">Save</td><td class="trash">delete</td></tr>';

            if (isEditing) {
                var nameInput = tableBody.find('input[name="name"]'),
                    dataInput = tableBody.find('input[name="data"]'),
                    tdNameInput = nameInput.closest('td'),
                    tdDataInput = dataInput.closest('td'),
                    currentEdit = tdNameInput.parent().find('td.edit');

                // Get current input values for newly created input cases
                var newNameInput = nameInput.prop('value'),
                    newDataInput = dataInput.prop('value');

                // Restore previous html values
                tdNameInput.empty();
                tdDataInput.empty();

                tdNameInput.html(newNameInput);
                tdDataInput.html(newDataInput);

                // Display static row
                currentEdit.html('Edit');
            }

            isEditing = true;
            tableBody.find('tr:last').before(trNew);
        });


    </script>
</div>


</body>


</html>
